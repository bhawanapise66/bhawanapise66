var predata="",coords=[],livetrailline1=[],livePremarkers=[],historyAnimationLayer=[],historylayercontional=[],animationLayer=[],prevehicle="";function LiveAnimation(e,r){if(prevehicle!=e.data.title&&(coords=[],predata=""),prevehicle=e.data.title,""==predata){ol.proj.fromLonLat(r);console.log("coord"+r),coords.push(r);var o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(r,"EPSG:4326","EPSG:3857"))});o.setStyle(function(e,r){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,20],scale:.8,anchorXUnits:"fraction",anchorYUnits:"pixels",src:"assets/mapimages/personicons/personicongreen.png"}),text:createTextStyle(e,r)})}),o.setProperties(e);var t=new ol.source.Vector({features:[o]}),n=new ol.layer.Vector({source:t});try{map.addLayer(n)}catch(e){}singleMarker.push(n)}else{for(var a=0;a<singleMarker.length;a++)map.removeLayer(singleMarker[a]);singleMarker=[];ol.proj.fromLonLat(r);if(coords.push(r),console.log("coord"+r),2==coords.length){var i="";i=Number(e.data.Speed)<=5?"blue":"red";try{AnimationRoute(coords,i)}catch(e){}try{AnimationForLive(e,coords)}catch(e){}(coords=[]).push(r)}try{PrePoint(predata,r)}catch(e){}}predata=e}function AnimationForLive(e,r){for(var o=0;o<animationLayer.length;o++)map.removeLayer(animationLayer[o]);animationLayer=[];var t=new ol.geom.LineString(r);t.transform("EPSG:4326","EPSG:3857");var n=t,a=n.getCoordinates(),i=a.length,s=new ol.Feature({type:"route",geometry:n}),l=(new ol.Feature({type:"geoMarker",geometry:new ol.geom.Point(a[0])}),new ol.Feature({geometry:new ol.geom.Point(a[0])}),new ol.Feature({geometry:new ol.geom.Point(a[i-1])})),c={route:new ol.style.Style({stroke:new ol.style.Stroke({width:3,color:[204,199,68,0]})}),icon:new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],src:"assets/mapimages/personicons/personicongreen.png"})})};l.setStyle(function(e,r){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],src:"assets/mapimages/personicons/personicongreen.png"})})}),l.setProperties(e);new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:2,src:"assets/mapimages/personicons/personicongreen.png"})});var y=new ol.source.Vector({features:[s,l]}),m=new ol.layer.Vector({source:y,style:function(e){return c[e.get("type")]}});map.addLayer(m),animationLayer.push(m),y.getFeatures()[0],y.once("change",function(e){"ready"===y.getState()&&y.getFeatures()[0]})}function AnimationRoute(e,r){var o=new ol.geom.LineString(e);o.transform("EPSG:4326","EPSG:3857");var t=o.getCoordinates(),n={LineString:new ol.style.Style({stroke:new ol.style.Stroke({color:r,width:3})})},a={type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:3857"}},features:[{type:"Feature",geometry:{type:"LineString",coordinates:t}}]},i=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(a)}),s=new ol.layer.Vector({source:i,style:function(e){return n[e.getGeometry().getType()]}});try{map.addLayer(s)}catch(e){}livetrailline1.push(s)}function ClearAnimation(){try{for(var e=0;e<animationLayer.length;e++)map.removeLayer(animationLayer[e]);animationLayer=[];for(e=0;e<historyAnimationLayer.length;e++)map.removeLayer(historyAnimationLayer[e]);historyAnimationLayer=[];for(e=0;e<animationPoints.length;e++)map.removeLayer(animationPoints[e]);animationPoints=[];for(e=0;e<livePremarkers.length;e++)map.removeLayer(livePremarkers[e]);livePremarkers=[];for(e=0;e<livetrailline.length;e++)try{map.removeLayer(livetrailline[e])}catch(e){}}catch(e){}for(e=0;e<historylayercontional.length;e++)try{map.removeLayer(historylayercontional[e])}catch(e){}historylayercontional=[]}function PrePoint(e,r){var o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(r,"EPSG:4326","EPSG:3857"))}),t=new ol.style.Style({image:new ol.style.Icon({scale:.2,anchorXUnits:"fraction",anchorYUnits:"pixels",src:"assets/mapimages/markers/bluedot.png"})});o.setStyle(t),o.setProperties(e);var n=new ol.source.Vector({features:[o]}),a=new ol.layer.Vector({source:n});map.addLayer(a),livePremarkers.push(a)}