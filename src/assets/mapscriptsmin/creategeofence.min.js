var drawInteraction,tracingFeature,startPoint,endPoint,snapInteraction,previewVector,baseVector,drawVector,plogonArray=[],pointsArray=[],drawing=!1;function CreateGeofence(e){function t(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function r(e,r,a){var o=t(r,e),n=t(r,a),i=((e[0]-r[0])*(a[0]-r[0])+(e[1]-r[1])*(a[1]-r[1]))/n;return Math.abs(o-i)<1e-6&&o<n}function a(e,t){return(e%t+t)%t}function o(e,o,n){var i=e.getGeometry();console.log("polygon function    "+e.getGeometry()),"MultiPolygon"===i.getType()&&(i=i.getPolygon(0));var s,l,c,p=i.getLinearRing().getCoordinates(),g=-1;for(s=0;s<p.length;s++)if(r(o,l=p[s],c=p[a(s+1,p.length)])){g=s;break}var d=[],u=0,y=[],m=0;for(s=0;s<p.length;s++){if(l=0===s?o:p[a(s+g,p.length)],c=p[a(s+g+1,p.length)],d.push(l),r(n,l,c)){d.push(n),u+=t(l,n);break}u+=t(l,c)}for(s=0;s<p.length;s++){if(l=p[a(g-s,p.length)],c=0===s?o:p[a(g-s+1,p.length)],y.push(c),r(n,l,c)){y.push(n),m+=t(n,c);break}m+=t(l,c)}return m<u?y:d}plogonArray=[],pointsArray=[],baseVector=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,url:"https://ahocevar.com/geoserver/wfs?service=wfs&request=getfeature&typename=topp:states&cql_filter=STATE_NAME='Idaho'&outputformat=application/json"})}),drawVector=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(100, 255, 0, 1)",lineDash:[10,10],width:2}),fill:new ol.style.Fill({color:"rgba(100, 255, 0, 0.3)"})})});var n=new ol.Feature({geometry:new ol.geom.LineString([])});previewVector=new ol.layer.Vector({source:new ol.source.Vector({features:[n]}),style:new ol.style.Style({stroke:new ol.style.Stroke({lineDash:[10,10],color:"rgba(255, 0, 0, 1)",width:9})})}),drawing=!1;var i={hitTolerance:10,layerFilter:function(e){return e===baseVector}};map.addLayer(baseVector),map.addLayer(drawVector),map.addLayer(previewVector);var s;map.on("click",function(e){if(drawing&&1==polygonFlag){var t=!1;map.forEachFeatureAtPixel(e.pixel,function(r){if(!tracingFeature||r===tracingFeature){if(t=!0,s=map.getCoordinateFromPixel(e.pixel),r===tracingFeature){endPoint=tracingFeature.getGeometry().getClosestPoint(s);var a=o(tracingFeature,startPoint,endPoint);drawInteraction.removeLastPoint(),drawInteraction.appendCoordinates(a),tracingFeature=null}startPoint=(tracingFeature=r).getGeometry().getClosestPoint(s)}},i),t?(map.removeInteraction(drawInteraction),map.removeInteraction(snapInteraction)):(n.getGeometry().setCoordinates([]),tracingFeature=null)}});var l=[];map.on("pointermove",function(e){if(tracingFeature&&drawing){var t=null;map.forEachFeatureAtPixel(e.pixel,function(r){tracingFeature===r&&(t=map.getCoordinateFromPixel(e.pixel))},i),t&&(endPoint=tracingFeature.getGeometry().getClosestPoint(t),l=o(tracingFeature,startPoint,endPoint)),n.getGeometry().setCoordinates(l)}}),snapInteraction=new ol.interaction.Snap({source:baseVector.getSource()}),"None"!==e&&(drawInteraction=new ol.interaction.Draw({source:drawVector.getSource(),type:e}),map.addInteraction(drawInteraction),map.addInteraction(snapInteraction),drawInteraction.on("drawstart",function(){drawing=!0}),drawInteraction.on("drawend",function(e){drawing=!1;for(var t=e.feature.values_.geometry.flatCoordinates,r=0;r<t.length;r++){var a="";if(r<1){var o=r+1;(s=[]).push(t[r]),s.push(t[o]),a=s;var i=new ol.proj.transform(a,"EPSG:3857","EPSG:4326");pointsArray.push(i),console.log("after conversion   "+JSON.stringify(pointsArray))}else{var s,l=2*r;o=l+1,l<t.length&&((s=[]).push(t[l]),s.push(t[o]),a=s,i=new ol.proj.transform(a,"EPSG:3857","EPSG:4326"),pointsArray.push(i))}if(""!=a){plogonArray.push(a);var c="<div class='popupMainDiv' style='    max-height: 300px; overflow: auto;'><table class='popCustomTable'><tr></tr><tr class='tableheader'><td colspan='2' style='text-align:center'>Create Polygon</td></tr><tr><td class='leftTd'>Name</td><td class='rightTd'><input type='text' class='form-control ' placeholder='Enter Name' id='polygonName' style=' background-color: white !important;  border: 1px solid blue !important; height: 25px !important; font-size: 11px; width: 165px !important; color:black;'></td></tr><tr><td class='leftTd'>Points</td><td class='rightTd'>";for(r=0;r<pointsArray.length;r++)c=c+"<span>"+pointsArray[r][1].toFixed(4)+" , "+pointsArray[r][0].toFixed(4)+"</span><br>";c+="</td></tr>",c+="<tr><td colspan='2'><button class='btn btn-primary' style='height:24px;float: right; margin-right: 41px;' onclick='InsertPolygon()'><h6 style='  font-size:12px;  margin-top: -3px;'>Save</h6></button></tr>",c+="</table></div>",content.innerHTML=c,popup.setPosition(plogonArray[0]),map.removeLayer(baseVector),polygonFlag=0}}n.getGeometry().setCoordinates([]),tracingFeature=null,map.removeInteraction(drawInteraction),map.removeInteraction(snapInteraction)}))}function ClearPolygonDraw(){try{drawing=!1,map.removeInteraction(drawInteraction),map.removeInteraction(snapInteraction);try{map.removeLayer(baseVector),map.removeLayer(drawVector),map.removeLayer(previewVector)}catch(e){}}catch(e){}}function InsertPolygon(){console.log(JSON.stringify(plogonArray));var e=JSON.stringify(plogonArray),t=JSON.stringify(pointsArray),r={param1:"",param2:document.getElementById("polygonName").value,param3:"polygon",param4:e,param5:"true",param6:"2E8B57",param7:t,pageID:pageId,pageName:pagename,pageURL:pageurl};$.ajax({url:apiurl+"insertgeofence",type:"post",data:JSON.stringify(r),headers:{Headerkey:headerkey,Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":"https://track.indtrack.com/vtsindtrackapi/","Access-Control-Allow-Methods":"GET, POST, OPTIONS, PUT, PATCH, DELETE","Access-Control-Allow-Headers":"Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers"},dataType:"json",success:function(e){if("Successfully saved."==e.entity){alert(e.entity);try{ClearPolygonDraw()}catch(e){}}else alert(e.entity)}})}function GetPolygonDetails(){var e={pageNo:"1",itemsPerPage:"20",searchBy:"",searchType:"",totalRecords:"NA",pageID:pageId,pageName:pagename,pageURL:pageurl};$.ajax({url:apiurl+"geofencedetails",type:"post",data:JSON.stringify(e),headers:{Headerkey:headerkey,Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":"https://track.indtrack.com/vtsindtrackapi/","Access-Control-Allow-Methods":"GET, POST, OPTIONS, PUT, PATCH, DELETE","Access-Control-Allow-Headers":"Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers"},dataType:"json",success:function(e){for(var t=e.entity.list,r=0;r<t.length;r++){var a=t[r].param2,o=JSON.parse(t[r].param4);o=o.coordinates;var n=t[r].param7;try{PlotPolygon(o,a,n)}catch(e){}}}})}